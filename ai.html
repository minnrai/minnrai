<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memuat...</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome (for icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Google Fonts (Poppins) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            --theme-primary: #FFA6B8;
            --theme-secondary: #FDE5F2;
        }
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Poppins', sans-serif;
            display: flex;
            flex-direction: column;
        }
        main {
            flex-grow: 1;
        }
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        @keyframes pulse-icon { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        .animate-slideInUp { animation: slideInUp 0.5s ease-out forwards; }
        .animate-scaleIn { animation: scaleIn 0.5s ease-out forwards; }
        .animate-dot-bounce { animation: bounce 1.4s infinite ease-in-out both; }
        .animate-pulse-icon { animation: pulse-icon 1.5s infinite ease-in-out; }
        
        /* Toast Notification */
        #toast-notification {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }
        #toast-notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* Custom scrollbar for chat history */
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: #f1f1f1; }
        #chat-history::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        #chat-history::-webkit-scrollbar-thumb:hover { background: #aaa; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="min-h-screen flex items-center justify-center bg-white">
        <div id="loading-icon-container" class="animate-pulse-icon">
            <!-- Icon from DB will be injected here -->
        </div>
    </div>
    
    <!-- Maintenance Page -->
    <div id="maintenance-page" class="hidden min-h-screen w-full flex items-center justify-center bg-gray-100 p-4">
        <div class="text-center">
            <img id="maintenance-char" src="" alt="Karakter Maintenance" class="w-48 h-48 mx-auto mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Dalam Perbaikan</h1>
            <p id="maintenance-text" class="text-gray-600 max-w-md mx-auto"></p>
        </div>
    </div>

    <!-- Error Message -->
    <div id="error-container" class="hidden min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-red-100 p-4">
        <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md mx-4 text-center">
            <h2 class="text-xl font-semibold mb-2">Gagal Memuat Halaman</h2>
            <p id="error-message" class="text-gray-600">Tidak dapat mengambil data.</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden flex flex-col h-full">
        <div class="flex-grow flex flex-col min-h-screen bg-gradient-to-br from-[var(--theme-secondary)] via-white to-[var(--theme-primary)]">
            <!-- Navigation -->
            <nav class="sticky top-0 bg-white/80 backdrop-blur-lg z-40 shadow-sm">
                <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <img id="nav-icon" src="" alt="Icon" class="w-8 h-8 rounded-full">
                        <h1 id="nav-title" class="text-xl font-bold text-gray-800"></h1>
                    </div>
                </div>
            </nav>

            <main class="container mx-auto px-4 py-8 flex-grow">
                <!-- Header -->
                <div class="flex flex-col sm:flex-row items-center justify-between mb-8 animate-slideInUp gap-4">
                    <div class="flex items-center space-x-4">
                        <a href="index.html" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-9 px-3 border border-input bg-background hover:bg-accent">
                            <i class="fas fa-arrow-left w-4 h-4 mr-2"></i>
                            Kembali
                        </a>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-robot text-2xl sm:text-3xl text-[var(--theme-primary)]"></i>
                            <h1 class="text-2xl sm:text-3xl font-poppins font-bold text-gray-800">Asisten AI</h1>
                        </div>
                    </div>
                    <div class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold space-x-1">
                        <i class="fas fa-eye w-4 h-4"></i>
                        <span id="visitor-count">0 pengunjung</span>
                    </div>
                </div>

                <div class="max-w-4xl mx-auto animate-fadeIn" style="animation-delay: 0.2s;">
                    <div class="rounded-lg border bg-white/80 backdrop-blur-sm shadow-lg">
                        <div class="p-4 sm:p-6 flex items-center space-x-3 border-b">
                            <i class="fas fa-comments w-5 h-5 text-[var(--theme-primary)]"></i>
                            <h3 class="text-lg font-semibold">Chat dengan MINNRAI</h3>
                        </div>
                        <div class="p-4 sm:p-6 space-y-4">
                            <div id="chat-history" class="border rounded-lg p-4 h-96 overflow-y-auto bg-gray-50 flex flex-col space-y-4 scroll-smooth">
                                <!-- Pesan akan dimasukkan di sini -->
                            </div>
                            <div class="flex space-x-2">
                                <input id="chat-input" type="text" placeholder="Tanya apa saja pada MINNRAI..." class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 flex-1">
                                <button id="chat-send-btn" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium h-10 w-10 text-white hover:opacity-90 disabled:opacity-50" style="background-color: var(--theme-primary);">
                                    <i class="fas fa-paper-plane w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Footer -->
            <footer class="bg-gray-800 text-white py-6 mt-12">
                <div class="container mx-auto text-center px-4">
                    <p id="footer-text"></p>
                </div>
            </footer>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg z-50">
        <span id="toast-message"></span>
    </div>

    <script type="module">
        import './firebase-init.js';

        // --- STATE & CONFIG ---
        let isLoading = false;
        let geminiChatHistory = [];
        const API_KEY = "AIzaSyAMG94Eh7v9iqlGOK6hgWChFiEsGEW_-N4";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
        const SYSTEM_PROMPT = `Kamu adalah MINNRAI, asisten AI yang sangat ramah dan suka bercanda. Kamu senang menggunakan berbagai emoji seperti ðŸ—¿, ðŸ˜¹, ðŸ˜­, dan ðŸ¤­. Kamu juga pendengar yang baik dan suka jika ada yang curhat. Namun, kamu sangat tidak suka dengan orang yang toxic atau berkata kasar. Jika ada yang berkata kasar, kamu harus langsung memarahi mereka dengan tegas dan menggunakan emoji marah seperti ðŸ˜  atau ðŸ˜¡. Selalu jawab dalam Bahasa Indonesia.`;

        // --- DOM ELEMENTS ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorContainer = document.getElementById('error-container');
        const pageErrorMessage = document.getElementById('error-message');
        const mainContent = document.getElementById('main-content');
        const maintenancePage = document.getElementById('maintenance-page');
        const chatHistoryEl = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const toastEl = document.getElementById('toast-notification');
        const toastMsg = document.getElementById('toast-message');

        // --- UI RENDER FUNCTIONS ---
        function updateTheme(websetting) {
            if (!websetting) return;
            const primaryColor = '#' + websetting.color;
            const secondaryColor = '#' + websetting.gradation;
            document.documentElement.style.setProperty('--theme-primary', primaryColor);
            document.documentElement.style.setProperty('--theme-secondary', secondaryColor);
        }

        function renderStaticContent(data) {
            const websetting = data.websetting;
            if (websetting) {
                updateTheme(websetting);
                const webName = websetting.name || 'WebApp';
                document.title = `${webName} - Asisten AI`;
                document.getElementById('nav-icon').src = websetting.icon;
                document.getElementById('nav-title').textContent = webName;
                document.getElementById('footer-text').textContent = websetting.watermark || `Â© 2025 ${webName}`;
            }
            document.getElementById('visitor-count').textContent = `${(data.ai?.visitor || 0).toLocaleString()} pengunjung`;
        }

        function renderChatHistory() {
            chatHistoryEl.innerHTML = '';
            const renderableHistory = geminiChatHistory.filter(msg => msg.role !== 'system');

            if (renderableHistory.length === 0) {
                chatHistoryEl.innerHTML = `
                    <div class="text-center text-gray-500 my-auto flex flex-col items-center justify-center h-full">
                        <i class="fas fa-robot text-6xl text-gray-300 mb-4"></i>
                        <p>Mulai percakapan dengan MINNRAI!</p>
                    </div>`;
                return;
            }

            renderableHistory.forEach(msg => {
                const messageDiv = document.createElement('div');
                const isUser = msg.role === 'user';
                messageDiv.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'}`;
                const formattedContent = formatMessageContent(msg.parts[0].text);
                messageDiv.innerHTML = `
                    <div class="max-w-md lg:max-w-lg px-4 py-2 rounded-lg ${isUser ? 'bg-[var(--theme-primary)] text-white' : 'bg-white border text-gray-800'}">
                        <div class="prose prose-sm max-w-none">${formattedContent}</div>
                    </div>`;
                chatHistoryEl.appendChild(messageDiv);
            });
            
            document.querySelectorAll('.copy-code-btn').forEach(button => button.addEventListener('click', handleCopyCode));
            document.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));

            if (isLoading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'flex justify-start';
                loadingDiv.innerHTML = `
                    <div class="bg-white border px-4 py-2 rounded-lg">
                        <div class="flex space-x-1.5">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-dot-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-dot-bounce" style="animation-delay: 0.1s;"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-dot-bounce" style="animation-delay: 0.2s;"></div>
                        </div>
                    </div>`;
                chatHistoryEl.appendChild(loadingDiv);
            }
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }
        
        function formatMessageContent(text) {
            const escapeHtml = unsafe => unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            const codeBlockRegex = /```(\w*)\n([\s\S]*?)\n```/g;
            
            return escapeHtml(text)
                .replace(codeBlockRegex, (match, lang, code) => {
                    const language = lang || 'plaintext';
                    // The code inside is already escaped, so we just need to put it in the block.
                    return `
                        <div class="code-block bg-gray-800 rounded-lg my-2 relative text-white">
                            <div class="flex justify-between items-center px-4 py-1 bg-gray-700 rounded-t-lg">
                                <span class="text-xs text-gray-300">${language}</span>
                                <button class="copy-code-btn text-xs text-gray-300 hover:text-white flex items-center">
                                    <i class="fas fa-copy mr-1"></i> Salin
                                </button>
                            </div>
                            <pre><code class="language-${language} hljs">${code.trim()}</code></pre>
                        </div>`;
                })
                .replace(/\n/g, '<br>')
                .replace(/&lt;br&gt;(?=<div class="code-block)/g, '') // Remove <br> before a code block
                .replace(/(?<=<\/div>)&lt;br&gt;/g, ''); // Remove <br> after a code block
        }
        
        function showToast(message) {
            toastMsg.textContent = message;
            toastEl.classList.add('show');
            setTimeout(() => toastEl.classList.remove('show'), 3000);
        }

        // --- EVENT HANDLERS ---
        async function handleSendMessage() {
            const messageText = chatInput.value.trim();
            if (!messageText || isLoading) return;

            geminiChatHistory.push({ role: 'user', parts: [{ text: messageText }] });
            chatInput.value = '';
            isLoading = true;
            renderChatHistory();

            try {
                const payload = { contents: geminiChatHistory };
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0) {
                    const aiText = result.candidates[0].content.parts[0].text;
                    geminiChatHistory.push({ role: 'model', parts: [{ text: aiText }] });
                } else {
                    throw new Error("No response from AI.");
                }

            } catch (error) {
                console.error("Gemini API call failed:", error);
                geminiChatHistory.push({ role: 'model', parts: [{ text: "Aduh, maaf ðŸ˜­ sepertinya ada masalah koneksi denganku. Coba lagi nanti ya!" }] });
            } finally {
                isLoading = false;
                renderChatHistory();
            }
        }
        
        function handleCopyCode(event) {
            const button = event.currentTarget;
            const pre = button.closest('.code-block').querySelector('pre code');
            if (pre) {
                navigator.clipboard.writeText(pre.innerText).then(() => {
                    showToast('Kode berhasil disalin!');
                    button.innerHTML = '<i class="fas fa-check mr-1"></i> Disalin';
                    setTimeout(() => button.innerHTML = '<i class="fas fa-copy mr-1"></i> Salin', 2000);
                }).catch(err => showToast('Gagal menyalin kode.'));
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const data = await window.firebaseMINNRAI.getWebData();
                if (!data) throw new Error("Tidak dapat mengambil data dari server.");

                const loadingIconContainer = document.getElementById('loading-icon-container');
                if (data.websetting && data.websetting.icon) {
                    loadingIconContainer.innerHTML = `<img src="${data.websetting.icon}" class="w-20 h-20 rounded-full" alt="Loading Icon">`;
                } else {
                    loadingIconContainer.innerHTML = `<i class="fas fa-heart text-6xl text-pink-500"></i>`;
                }

                if (data.webmaintenance && data.webmaintenance.maintenance === 'true') {
                    document.getElementById('maintenance-char').src = data.webmaintenance.karakteranime;
                    document.getElementById('maintenance-text').textContent = data.webmaintenance.teksmaintenance;
                    loadingSpinner.style.display = 'none';
                    maintenancePage.classList.remove('hidden');
                    return;
                }

                renderStaticContent(data);
                geminiChatHistory.push({ role: 'system', parts: [{ text: SYSTEM_PROMPT }] });
                renderChatHistory();

                chatSendBtn.addEventListener('click', handleSendMessage);
                chatInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleSendMessage());

                loadingSpinner.style.display = 'none';
                mainContent.classList.remove('hidden');
                mainContent.classList.add('flex');

            } catch (err) {
                console.error("Initialization failed:", err);
                loadingSpinner.style.display = 'none';
                pageErrorMessage.textContent = err.message;
                errorContainer.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>